# @sqs/febs-cli

Frontend build system command line interface


## Prerequisites
FEBS recommends using `npm >= 6.8` and `node >= 10`.

## Getting Started

1. Install the febs cli as a dev dependency:
```sh
npm i --save-dev @sqs/febs-cli
```

2. Configure febs
  
  You can run febs with its default configuration.
  ```sh
    npx febs build
  ```
  
  To see the defaults, run:
  ```sh
   npx febs --help
  ```

  To override the defaults, you can use command line flags or a config file. 

  ***Configuring FEBs from the command line***

  ```sh
  npx febs --watch
  ```

  ***Configuring FEBs from a config file***

    - add febs.config.js to the root at your project
    - export a config object:

  ```js
    // For example, if you are building a typescript library

    module.exports = {
      library: true,
      typescript: true
    }
  ```

3. Add a build script to your package.json:
```json
{
  "scripts": {
    "build": "febs build",
    "build:all": "febs build --locale=all",
    "watch": "febs build --watch"
  } 
}
```


Default Configurations: <a name="default-configurations"></a>
```json
{
  locale: [ 'en-US' ],
  parallel: 6,
  watch: false,
  library: false,
  react: true,
  typescript: false,
  tslint: false,
  i18n: true,
  logLevel: 'info',
  paths: {
    config: 'config',
    cjsOutDir: 'cjs',
    dist: 'dist',
    esmOutDir: 'lib',
    frontendBuildCache: 'node_modules/.cache/fbs',
    public: 'public',
    root: '',
    scripts: 'scripts',
    src: 'src',
    translations: 'translations'
  },
  production: process.env.NODE_ENV || false,
  buildIgnorePatterns: [],
}
```

## FEBS Development Server

FEBS includes an implementation of the Webpack Dev Server that can be run with `febs start`.

See the [`Configuration Options`](#start-options) section below for available configuration options for this command.

### Example

```json
// package.json
{
  "scripts": {
    "start": "febs start"
  }
}
```
Then in the terminal:
```sh
> npm start
```

## Configuration Options

### Global options

#### logLevel
This option can be any of the following options supported by @febs/logger:
* silent
* error
* warn
* info
* http
* verbose
* debug
* silly

By default it is set to info.

***Note*** that this configures the log level of febs tools. It does NOT configure the log level 
of the webpack compilation, which is set to `minimal` by default. 
Use your webpack configuration to specify what stats should be logged by the Server.
It can be adjusted by setting the `stats` option on the [devServer](https://webpack.js.org/configuration/dev-server/#devserverstats-) object.


#### paths

this is an object that is really a number of flags. You should set this in your febs.config.js

Here are the supported paths:
* dist - the output directory for your app bundles ( not used by libraries )
* public - the location for public files to serve
* src - the location of your source files
* translations - location of all translation yaml files.
* frontendBuildCache - the location for the webpack cache

### Build options
* locale - A list of locales to build. Valid options: "en-US", "es-419", "fr-FR", "it-IT", "de-DE", "pt-BR", "all"
* parallel - cpu's to use in a parallel build. Default is number of CPUs - 2.
* watch - If set, run in watch mode, rebuilding as the source changes.
* webpackConfig - Path to Webpack configuration file
* library - if set febs will not webpack your code, but will instead just bablify it.
* typescript - Set this to enable TypeScript support in apps or libraries.

  For mixed typescript/javascript libraries, add `allowJs` to the [`compilerOptions` in tsconfig.json](https://www.typescriptlang.org/docs/handbook/compiler-options.html). This will instruct the typescript compiler to output declaration files for the js files in your build.
  Requires [typescript version >= 3.7](https://devblogs.microsoft.com/typescript/announcing-typescript-3-7/#--declaration-and--allowjs)

* tslint - in webapps with typescript support, this runs tslint during the build. Useful in watch mode.
* i18n - required to enable i18n loaders.
* production - Build for a production environment
* graphiteGroup - in webapps, report build stats to graphite under the specified group name
* stats - in webapps, collect script and Webpack metrics and post them to graphite. Requires ***graphiteGroup*** to be set. See [Setting up graphite and Grafana](#setting-up-graphite-and-grafana)
* buildIgnorePatterns - [For libraries only] Glob patterns for files and/or directories to explicitly ignore from the dist directories. Set this if you find files and/or folders in your dist directories that you wish to exclude (test files, local dev scripts, etc).

### Start options <a name="start-options"></a>
* `hot` - Enables hot module replacement. Defaults to `true`. Disable with `--no-hot`.
  [Corresponds to `devServer.hot` in your webpack config](https://webpack.js.org/configuration/dev-server/#devserverhot)
* `open` - Open a browser on `start`. Defaults to `true`. Disable with `--no-open`.
  [Corresponds to `devServer.open` in your webpack config](https://webpack.js.org/configuration/dev-server/#devserveropen)
* `locale` - A list of locales to build. Defaults to `en-US`. Valid options: "en-US", "es-419", "fr-FR", "it-IT", "de-DE", "pt-BR", "all".
* `webpackConfig` - Path to Webpack configuration file.

## Setting up graphite and Grafana
1. Add graphiteGroup option to your febs.config.js. 

This value determines the location of your data in [Graphite](https://wiki.squarespace.net/display/OBSV/Graphite). 
Recommended: 'PROD.all.<your-app-name> OR contact #sre-observability about your specific use case
Start with the prefix 'PROD.all' (This is the path for non-host-specific metrics)
Example:
  'PROD.all.my-app' will result in:
  PROD/all/my-app/frontend-asset-sizes/<branch-name>/
  PROD/all/my-app/frontend-webpack-speed/<branch-name>/

You can see the current structure of the database [here](http://graphite-vip.drt.ewr.prod.squarespace.net:8080/).
FEBs is configured to post to the NJ datacenter: 
```js
const GRAPHITE_HOST = 'graphite-vip.drt.ewr.prod.squarespace.net';
const GRAPHITE_PORT = 2023;
```

2. Create a Grafana dashboard

    1. clone the [febs-example-webapp dashboard](https://graphs.squarespace.net/d/PuWvkw7Wz/febs-example-webapp) (use the **save as** button)
        - OR [create a new dashboard](https://wiki.squarespace.net/pages/viewpage.action?pageId=60578529)
    
    2. create variables to access the data series:
      - $assetsPath: <graphite_group>.frontend-asset-sizes.<branch_name>
      - $webpackSpeedPath: <graphite_group>.frontend-webpack-speed.<branch_name>
      - if you are cloning the example, update the $prefix variable values to match your graphiteGroup and replace ***DEV*** with <branch_name> in all variables

 3. available metrics: 
 
    1. File Sizes

    Minified and gzipped sizes are collected for all js files, included translated ones.   
    Input file sizes and minification diffs are collected only for en-US files.
    At <GRAPHITE_GROUP>.frontend-asset-sizes.<BRANCH_NAME>

    ```js
    {
      // Flat objects with KV pairs of file names and their sizes
      js: { 'main-en-US-js': 136959, ... },      // minified js file sizes
      css: { 'App-css': 153556, ... },           // minified css file sizes
      jsGzipped: { 'main-en-US-js': 27909, ... },// minified gzipped js files
      cssGzipped: { 'App-css': 115440, ... },    // minified gzipped css files
      jsStats: { 'App': 157452, ... },           // input js file sizes (before webpack transformations)
      jsMinDiff: { 'App': 142834, ... },         // decrease in js file sizes after minification, en-US only

      // Totals
      jsTotal: 57750847,                    
      cssTotal: 153556,                     
      cssGzippedTotal: 115440,
      jsGzippedTotal: 10632880,
      build: 123 // build number 
    }
    ```
    Example Grafana query to chart the size for all en-US minified js files:

```
aliasByNode(grep(PROD.all.febs-example-webapp.frontend-asset-sizes.DEV.js.*, 'en-US'), 6)
```

  2. Webpack Speeds
      These metrics are collected only during the default locale build.   
 At <GRAPHITE_GROUP>.frontend-webpack-speed.<BRANCH_NAME>

 ```js
  { 
    loaders: { 'css-loader+postcss-loader+less-loader': 1105, ... },
    plugins: { 'DefinePlugin': 1, ... }
  } 
 ```
 Example Grafana query to chart the speed of all webpack plugins:
 ```
 aliasByNode(grep(PROD.all.febs-example-webapp.frontend-webpack-speed.DEV.plugins.*, 'en-US'), 6)
 ```
