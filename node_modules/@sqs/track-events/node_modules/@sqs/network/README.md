# @sqs/network &middot; [![Build Status](https://delivery-external.squarespace.net/api/badges/sqsp/network-bridge/status.svg)](https://delivery.squarespace.net/sqsp/network-bridge)

> Handle network requests in web and react native environments.

Under the hood, `@sqs/network` will provide an instance of either an `axios` if you are on web (or a mobile webview) or `NetworkBridge` if you are on react-native.

On the web, `@sqs/network` will introduce an [axios interceptor](https://github.com/axios/axios#interceptors) to apply a CSRF token in the headers that is retrieved from a cookie called `crumb`. **To authenticate with v6 API methods there must be a CSRF token in this 'crumb' cookie.**

On react-native, authentication can be provided through the `parameters` argument for the `Network` methods.

## Usage

Install the package:

`npm install --save @sqs/network`

Import the package:

```javascript
import Network from "@sqs/network";
// or, in CommonJS environments:
const Network = require("@sqs/network").default;
```

Use the package:

```javascript
const MyAPIMethods = {
  load() {
    return Network.get(API_PATH);
  },

  save(data) {
    return Network.post(API_PATH, { data: MY_DATA });
  }
};
```

## Overriding / Customizing Behavior

On web, the default export `Network` is simply a pre-configured instance of `customInstance.`
The `customInstance` method allows you to override the default `Network` behavior with custom request / response interceptors.
It is simply a method that accepts an interceptor configuration.

Example:

```javascript
import { customInstance, interceptors } from "@sqs/network";
// or, in CommonJS environments:
const { customInstance, interceptors } = require('@sqs/network');

// can implement interceptors for either/both network requests or network responses.
// each key takes an array of interceptors, invoked sequentially. Interceptors must implement
// a `fulfilledHandler` and a `rejectedHandler` method. See interceptors/*.js for examples.
const myInstance = customInstance({
  request: [interceptors.crumbInterceptor]
});

myInstance.get(API_PATH);
```

In addition to the default `crumbInterceptor`, The package exposes an optional `paramsSerializer` interceptor, useful for ensuring query parameters are serialized in a way compatible with the [default OpenAPI serialization](https://swagger.io/docs/specification/serialization/#query) in use by Tyson microservices.

## Errors

### ApiError

This package exposes an ApiError class which can be used by consumers when catching errors from `@sqs/network` (or any `axios` instance). Catching errors from the network module and creating these `ApiError`s helps with error logging by creating an error message and stacktrace which are unique to the file in which they were created.

#### Example

```javascript
import Network, { errors } from '@sqs/network';
import { reportError } from 'utils/errorReporter'; // could use Sentry, TrackJS, etc

const fetchUserProfile = () => {
  return Network.get(USER_PROFILE_PATH)
    .then(onSuccess)
    .catch(networkError => {
      const apiError = new errors.ApiError(
        // message                      functionName        cause
        'Could not fetch user profile', 'fetchUserProfile', networkError
      );

      // handle the error if possible...
      // ...and/or report the error:
      reportError(apiError);

      // if the error could not be handled here, throw your `ApiError`
      // for potential handling by consumers:
      throw apiError;
    });
};
```

#### ApiError Schema

property       | type             | description
---------------|------------------|---------------------------------------------
`message`      | `string`         | A brief message describing the error
`functionName` | `string`         | A unique identifier (passed to constructor) for the function in which the error occurred
`cause`        | `Error`          | The original error (passed to constructor) which caused this error to be thrown. Typically an Axios error.
`request`      | `XMLHttpRequest` | The request that caused the errant response, or `undefined` if the cause was not an Axios error.
`config`       | `object`         | The request config provided to Axios, or `undefined` if the cause was not an Axios error. See: [Axios Config Schema](https://github.com/axios/axios#request-config)
`response`     | `object`         | The server response, or `undefined` if no response was received from the server. See: [Axios Response Schema](https://github.com/axios/axios#response-schema)

#### Type Checking for ApiErrors

Because of Babel limitations with extending builtins, `instanceof` checks on ApiError instances will fail (e.g. `someApiError instanceof ApiError`). As a workaround, the `ApiError` class includes a static method to use for type checking, `isApiError`.  Usage:

```javascript
ApiError.isApiError(new ApiError('test1', 'testFxn', cause)); // true
ApiError.isApiError(new TypeError('test2')); // false
```

## Android

### Adding the dependency

Add the location of `node_modules` and register the project by name in the root `settings.gradle`

```groovy
// location of node modules
def nodeModulesDir = new File("../node_modules")

// registering the project
include ':rn-network-bridge'
project(':rn-network-bridge').projectDir = new File(nodeModulesDir, '@sqs/rn-network-bridge/android')
```

Then add the project as a dependency to the android app `build.gradle`:

```groovy
dependencies {
  implementation project(':rn-network-bridge')
}
```

### Registering the component

The last step within `Java` is to either register the entire `NetworkPackage`, or to [register the individual modules](https://facebook.github.io/react-native/docs/native-modules-android#register-the-module). If the components are not registered, they will not be available from JavaScript.

#### Package

To include all native components at once, you can register the entire package within the `ReactApplication`.

```java
package com.example.android;

import android.app.Application;

import com.facebook.react.ReactApplication;
import com.facebook.react.ReactNativeHost;
import com.facebook.react.ReactPackage;
import com.facebook.react.shell.MainReactPackage;
+ import com.squarespace.reactnative.NetworkPackage;
+ import com.squarespace.reactnative.network.client.ClientFactory;

import java.util.Arrays;
import java.util.List;


public class MainApplication extends Application implements ReactApplication {

  private final ReactNativeHost mReactNativeHost = new ReactNativeHost(this) {
    public boolean getUseDeveloperSupport() {
      return BuildConfig.DEBUG;
    }

    @Override
    protected List<ReactPackage> getPackages() {
      return Arrays.<ReactPackage>asList(
          new MainReactPackage(),
+         new NetworkPackage(createClientFactory())
      );
    }
  };

  @Override
  public ReactNativeHost getReactNativeHost() {
    return mReactNativeHost;
  }

+  private ClientFactory createClientFactory() {
+    // implement your own client factory
+  }

}
```

## Development

This repo uses [nodenv](https://github.com/nodenv/nodenv) for Node.js version management so please make sure that you have it installed with [nodenv-aliases](https://github.com/nodenv/nodenv-aliases) plugin. You can install it by running:

```sh
brew install nodenv
brew install nodenv/nodenv/nodenv-aliases
```

After that please make sure that you have installed Node.js version from `.node-version` file. You can install it by running `nodenv install major.minor.patch`. You can see all available versions by running `nodenv install --list` or by looking at the [official Node.js page](https://nodejs.org/en/download/releases).

Be sure to run `npm ci` to install the necessary development dependencies.

This repository uses the [conventional commit](https://www.conventionalcommits.org/en/v1.0.0/) message format.
Your commit messages should follow this format. If you'd like, you can run `npm run git:commit` to be prompted
interactively for the fields necessary for your commit message.

## Publishing

The `@sqs/network` package is automatically versioned and published by Drone.
When you merge a PR into `master` it will trigger versioning and publishing.
The only strict requirement is conventional commits. Please use `npm run git:commit` for assistance.
