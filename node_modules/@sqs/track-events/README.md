# Track Events Library V2

A client-side library for standardizing and posting our event tracking data. Data is formatted to match the new Data Pipeline (V2).
The V2 Pipeline is not backwards compatible with V1, therefore upgrading to V2 requires a refactor to the client code.

# Documentation

### Setup

```npm i --save @sqs/track-events```

#### Examples

All of the trackers in this example record the exact same event payload.
```
import TrackEvents from '@sqs/track-events/v2';

// Minimum configuration, using only custom schema name
const tracker1 = new TrackEvents({
  customSchemaName: 'LocalListings',
})
tracker.track({
  'action: 'view',
  'actor': 'user',
  'event_owner_team': 'cdis',
  'event_source': 'web',
  'object_display_name': 'Location Management'
  'object_identifier': 'location-list',
  'object_type': 'panel',
  'product_area': 'location_management',
  'product_page': 'location_management',
  'product_section': 'location-list',
})


// Example with additional configuration and base payload
const tracker2 = new TrackEvents({
  // Configuration -- see below
  customSchemaName: 'LocalListings',
  logging: true,
  useBeacon: false,
}, {
  // Default Payload -- see below
  'action: 'view',
  'actor': 'user',
  'event_owner_team': 'cdis',
  'event_source': 'web',
  'object_display_name': 'Location Management'
  'object_identifier': 'location-list',
  'product_area': 'location_management',
  'product_page': 'location_management',
  'product_section': 'location-list',
})

tracker2.track({
   'object_type': 'panel',
})


// spawnTracker example: Inherit the base payload from tracker2 and add
// another field to the base payload. All of our event data is already
// in the base payload, so no additional data needs to be passed into
// track()
const tracker3 = tracker2.spawnTracker({
   'object_type': 'panel',
})
tracker3.track({});


// Example with default configuration and a base payload
const tracker4 = new TrackEvents({
  customSchemaName: 'LocalListings',
}, {
  'action: 'view',
  'actor': 'user',
  'event_owner_team': 'cdis',
  'event_source': 'web',
  'object_display_name': 'Location Management'
  'object_identifier': 'location-list',
  'object_type': 'THIS WILL GET OVERRIDDEN',
  'product_area': 'location_management',
  'product_page': 'location_management',
  'product_section': 'location-list',
})
tracker4.track({
  'object_type': 'panel',
})
```

#### Configuration
```
  DATA-TYPE     PROPERTY-NAME               DESCRIPTION
  _____________________________________________________
  string        customSchemaName            The name of your Custom Schema, e.g. 'frontsite', see [scheme examples] (https://github.com/sqsp/events-schemas/tree/master/schemas/pipeline2/events). Field is required
  enum          sourceEnvironment           The source environment e.g. 'dev', 'staging', 'prod', (see below). Defaults to 'dev'
  string        devBaseDomainUrl            The base domain for the url where events are fired (see below) used in dev. Defaults to 'https://events.stage.sqsp.net'
  boolean       logging                     Enable if you want to see logging in the console. Defaults to false
  boolean       useBeacon                   Disable if you want events to fire as XHRs instead of Beacons (useful for inspecting request payload). Defaults to true
  boolean       validateMode                Fires events to '/api/v1/clanker/validate-event-content/' for validation. Defaults to false
  boolean       fireEvents                  Enables / disables event firing, useful for not firing events in dev. Defaults to true
```

#### Source Environment and Base Domain Url
  `sourceEnvironment` can be any of 'dev', 'staging', or 'prod'. Dev and staging will both fire events to staging. However, in dev this will likely cause CORS issues depending on your environment. In dev you can use the `devBaseDomainUrl` to change the domain and proxy the events to staging to avoid CORS problems. By default requests are sent to 'https://clanker-events.stage.sqsp.net/api/v1/clanker/events'

#### Base Payload
The payload defined here will be sent with each event tracked, unless any fields are overridden in your track call. You can define values for any fields defined in the schemas (common or custom). Developers are encouraged to set fields here that never change across `track()` calls; this usually applies to the `event_owner_team`, `event_source`, `product_area` fields.

## Event Tracking Documentation

If this is your first time tracking events for event pipeline 2, there's other event tracking documentation that you should read.

The [event tracking process doc](https://wiki.squarespace.net/display/UEDA/1.+Introduction) gives a step-by-step guide on how to track events. It also links out to descriptions about how event data is structured, in the new event data pipeline. Anyone who is involved with tracking events (Engineering, Data Science) should read this document.

If you're curious to learn more about the event pipeline itself (its architecture, what kind of data the service accepts), read [EPA's documentation](https://wiki.squarespace.net/display/EPA/Events+Pipeline+V2).

### Helpful Links
  - [Data Science Guide to Events](https://wiki.squarespace.net/display/STAN/Data+Science+Guide+to+Events)
  - [Browser Common Schema](https://github.com/sqsp/events-schemas/blob/master/schemas/pipeline2/service/browser/BrowserCommon.avdl)
  - [Custom Schema Examples](https://github.com/sqsp/events-schemas/tree/master/schemas/pipeline2/events)
  - [Manifest Example](https://docs.google.com/spreadsheets/d/1bVVUmsN08VV05mJBzXeeSJNlpjPgnTsG5cRE52e3g6w/edit#gid=1945566552)
  - [Manifest Template](https://docs.google.com/spreadsheets/d/1acVDymNgNgHRehSN0elbTLETFVcSJY812Rw7PUZj_c8/edit#gid=1757267356)


## Road map:
  - React Native
  - Event batching



# Track Events Library V1 (Deprecated)

A clientside library for standardizing and posting our event tracking data. Data is formatted to match the New Data Pipeline (July 2018).

Find it on [NPM](https://artifactory.squarespace.net/artifactory/npm-private/.npm/%40sqs/track-events/%40sqs/) or [Stash](https://github.com/sqsp/track-events)
And read the [Design Document](https://docs.google.com/document/d/1olSuaxbZBSBsHLpTbRFPiG4y3NhNjCb2uGld4FqJ6DE)


## Event Tracking Documentation

If this is your first time tracking events (for the new event pipeline), there's other event tracking documentation that you should read.

The [event tracking process doc](https://docs.google.com/document/d/17mLn9GIlM4lAS2LnTzZGZ_qQzprIj0ndje_USurh0bg/edit) gives a step-by-step guide on how to track events. It also links out to descriptions about how event data is structured, in the new event data pipeline. Anyone who is involved with tracking events (Engineering, Analytics) should read this document.

If you're curious to learn more about the event pipeline itself (its architecture, what kind of data the service accepts), read the Data Platform team's [documentation here](https://docs.data-platforms.squarespace.net/docs/master/latest/developers/infrastructure/events_pipeline/).


## Helpful Links

Common Schema:
https://github.com/sqsp/events-schemas/blob/master/schemas/pipeline1/common/common.avdl

Custom Schemas:
https://github.com/sqsp/events-schemas/tree/master/schemas/pipeline1/custom

Enums:
https://github.com/sqsp/events-schemas/blob/master/schemas/enums.avdl

Manifest Example:
https://docs.google.com/spreadsheets/d/1TIdnoxkdsXt5u2NdV9VmTIAwcaDx67yIOjSVzvJvz7o


## Documentation

### Setup

#### Examples

All of the trackers in this example record the exact same event payload.
```
import TrackEvents from '@sqs/track-events/v1'

// Minimal example; use default configuration, no custom schema, and no base payload
const tracker1 = new TrackEvents()
tracker.track({
  'event_owner_team': 'frontsite',
  'event_source': 'web',
  'product_area': 'frontsite',
  'product_page': 'www',
  'product_section': 'domains-overlay',
  'product_design_identifier': 'home-nov-2018',
})


// Example with additional configuration and base payload
const tracker2 = new TrackEvents({
  // Configuration -- see below
  customSchemaName: 'frontsite',
  logging: true,
  url: 'https://events.stage.sqsp.net/api/v1/events',
  useBeacon: false,
}, {
  // Default Payload -- see below
  'event_owner_team': 'frontsite',
  'event_source': 'web',
  'product_area': 'frontsite',
  'product_page': 'www',
  'product_section': 'domains-overlay',
})

tracker2.track({
  'product_design_identifier': 'home-nov-2018',
})


// spawnTracker example: Inherit the base payload from tracker2 and add
// another field to the base payload. All of our event data is already
// in the base payload, so no additional data needs to be passed into
// track()
const tracker3 = tracker2.spawnTracker({
  'product_design_identifier': 'home-nov-2018',
})
tracker3.track({});


// Example with default configuration and a base payload
const tracker4 = new TrackEvents({}, {
  'event_owner_team': 'frontsite',
  'event_source': 'web',
  'product_area': 'frontsite',
  'product_page': 'www',
  'product_section': 'domains-overlay',
  'product_design_identifier': 'overrideThisValue',
})
tracker4.track({
  'product_design_identifier': 'home-nov-2018',
})
```

#### Configuration
```
  DATA-TYPE     PROPERTY-NAME               DESCRIPTION
  _____________________________________________________
  string        customSchemaName            The name of your Custom Schema, e.g. 'frontsite', see [custom_schemas.yaml](https://github.com/sqsp/events-schemas/blob/master/custom_schemas.yaml) for the full list. Default is none
  boolean       logging                     Enable if you want to see logging in the console, default is false
  string        url                         The URL of the service to send events to, default is the production service: 'https://events.stage.sqsp.net/api/v1/events'
  boolean       useBeacon                   Disable if you want events to fire as XHRs instead of Beacons (useful for inspecting request payload), default is true
```

#### Base Payload
The payload defined here will be sent with each event tracked, unless any fields are overridden in your track call. You can define values for any fields defined in the schemas (common or custom). Developers are encouraged to set fields here that never change across `track()` calls; this usually applies to the `event_owner_team`, `event_source`, `product_area` fields. Refer to the [event schemas](https://github.com/sqsp/events-schemas/tree/master/) for which fields are required/optional.


### Usage

#### track()
Tracks an event with the given payload. You can define values for any fields defined in the schemas (common or custom) here.
```
trackEvents.track({
  'actor': 'user',
  'action': 'click',
  'object_type': 'button',
  'object_identifier': 'checkout',
  'product_page': 'www',
  'product_section': 'domains-overlay',
})
```

#### spawnTracker()
Spawns a new TrackEvents instance based off the parent and ammended with additional base payload. This is useful in cases when you find yourself tracking multiple events that share lots of common payload.
```
const ctaTracker = trackEvents.spawnTracker({
  'actor': 'user',
  'action': 'click',
  'object_type': 'button',
  'object_identifier':  'cta',
  'product_page': 'www',
  'product_design_identifier': 'home-nov-2018',
})

ctaTracker.track({
  'destination_url': '/templates',
  'object_display_name': 'Get Started',
  'product_section': 'hero',
})
```


## Roadmap:
 * Cache events if client goes offline and send them upon reconnection
 * Send using [requestIdleCallback](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback)
 * Implement an easier way to test/QA events
 * Validate against data team's [avdl schema files](https://github.com/sqsp/events-schemas/blob/master/schemas/pipeline1/common/common.avdl)


## Track Events Google Spreadsheets Add-on (Optional)
1. Install [Google Spreadsheets Add-on](https://chrome.google.com/webstore/detail/sqstrack-events/kfmbheagibkjfmoigjpligjibcdhndcp) to your Google Spreadsheets using your Squarespace account.
2. After installing you will see a new optin under the `"ADD-ONS"` tab called `"@sqs/Track Events"`
3. Hover over this option and two new options will appear; 'Prepare Sheet with tracking properties' and 'Generate JSON and AVDL'
4. Click `Prepare sheet with tracking properties` and the spreadsheet will become filled with the various properties associated with the new event pipeline.
5. In the top row, fill in various events you want to track
6. In the blue area "Custom Event Properties" you can add the custom properties that are used in the Custom AVDL Schema as well as each JSON object that is passed per event.
7. Once all event data and values have been defined, in "ADD-ONS" click `Generate JSON and AVDL` to auto-generate the JSON objects associated with each tracking event

## Publishing updates

When your PR is merged, the `publish` step will run from Drone CI.

## Migrating from 3.x.x to 4.x.x

In older versions of the `@sqs/track-events` package, the usage pattern might have looked like this:

```
import TrackEvents from '@sqs/track-events/v2';

const client = new TrackEvents();

client.track();
```

In versions 4.0.0 and higher, instead usage should look like the following:

```
import { v2 as TrackEvents } from '@sqs/track-events';

const client = new TrackEvents();

client.track();
```

Usage for v0 and v1 clients will work similarly. If a bundler is configured correctly for production output, the unused client code will be tree-shaken appropriately.

# Release Notes

## 4.2.3
- Updates dependencies to drop vulnerabilities introduced by unnecessary react-native packages
## 4.2.2
- Adds `maybeProcess` util function for safely accessing `process` variable between server and client
## 4.2.1
- Rounds the browser_window_width and browser_window_height properties to prevent decimal values upserted (fallbacks to null)
## 4.2.0
- Adds Acuity domains into the config of the V2 event client
## 4.1.0
- Restores `SiteVisitorClient` export
## 4.0.0
- **DEPRECATED:** Use 4.1.0+ instead
- Provides typings for package consumers
- **BREAKING CHANGES:**
  - Alters package consumer import conventions (see [migration notes](#migrating-from-3xx-to-4xx))
