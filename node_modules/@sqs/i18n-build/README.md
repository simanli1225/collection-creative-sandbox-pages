# @sqs/i18n-build

## Overview
This library provides frontend i18n utilities for extracting, generating and
loading translations.

## Publishing to NPM

See [CONTRIBUTING.md](../../CONTRIBUTING.md)

## Table of Contents
 1. [Extraction and Generating](#extraction-and-generating)
 1. [Loading YAML files](#loading-yaml-files)
 1. [Building with Webpack and translations replacement](#building-with-webpack-and-translations-replacement)
 1. [General questions](#general-questions)

## Extraction and Generating

### CLI

Command line interface and utilities for dealing with translations in source code. It parses Frontend modules, finds translations helpers and extracts english copy into YAML files for Idioma.

Translation helpers include `<T>`, `<Plural>`, `t()` and `pluralize()`.

### Within site-server

This package is installed in the v6's [universal package.json](https://github.com/sqsp/squarespace-v6/blob/master/site-server/src/main/webapp/universal/package.json).

For extracting strings in site-server, jump to the [Usage](#Usage) portion of this guide.

### Outside of site-server

For usage outside of site-server, reach out to [i18n-eng@squarespace.com](mailto:i18n-eng@squarespace.com) or #i18n-eng on slack.

### Usage

#### Command line arguments

`@sqs/i18n-build` is powered by the command line. There is only one invocable command:

```sh
> sqs-i18n-extract "--help"

Usage: sqs-i18n-extract [options] [directory...]

Extracts i18n strings from Frontend code

Options:
  -v, --version  output the current version
  -d, --dry-run  run command but do not write results to disk (default: false)
  -h, --help     display help for command
  --enforce-project-spelling <spellings...>     Provide an optional list of project keys for which variations are not allowed
```

Example:
```sh
> sqs-i18n-extract --enforce-project-spelling apps.App scripts-v6.block
```

##### Requirements

There are no required arguments to run `sqs-i18n-extract` but your projects must have the following directory structure:
```sh
my-awesome-app/
  ├── sqs-i18n-translations/
    ├── meta/
    ├── strings/

```

##### Optional arguments

* `[directory...]`: You can specify one or more directory to start extraction from. By default extraction is run from the current working directory. Example:
```json
  "i18n:extraction": "sqs-i18n-extract src/",
```

`-d, --dry-run`: validates extraction and generation process without writing anything to disk


##### Output
The `sqs-i18n-extract` command generates as many YAML files as there are project names in the extraction JSON. Each project name in the extraction JSON should map to a single generated YAML file.

## Loading YAML files

Generated and translated YAML files can be loaded as JS objects via a provided Webpack loader

### Usage

`@sqs/i18n-build/lib/yaml-loader` reads a Yaml file and returns a JavaScript module.

_file.yaml_

```yaml
myKey: "Is very cool!"
```

_file.js_

```js
import data from 'file.yaml'
console.log(JSON.stringify(data));
// { myKey: "Is very cool!" }
```

_webpack.config.js_

```js
module.exports = {
  module: {
    rules: [
      {
        test: /\.yaml$/,
        use: [
          '@sqs/i18n-build/lib/yaml-loader',
        ],
      }
    ]
  }
}
```

_output_

```sh
> "Is very cool!"
```

### Properties

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)?** config options.
    -   `options.module` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** Whether to load this as a cjs or es module.
    -   `options.filename` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** filepath for logging errors. defaults to the resource path.
    -   `options.onWarning` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)?** callback for warnings.
    -   `options.json` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)?** compatibility with JSON.parse.
    -   `options.schema` **yaml.Schema?** Specific yaml schema to apply.

### Examples

```javascript
const { DEFAULT_FULL_SCHEMA } = require('js-yaml');
 module.exports = {
   module: {
     rules: [
       {
         test: /\.yaml$/,
         use: [
           {
             loader: '@sqs/i18n-build/lib/yaml-loader',
             options: {
               module: 'es',
               json: true,
               schema: DEFAULT_FULL_SCHEMA
             }
           }
         ],
       }
     ]
   }
 };
```

## General questions

### How are unique IDs calculated?

The md5 hash is generated from `notes`, `value`, and `project`. This can be seen in `hash.ts` in the function `getHashKey`. 

For example, let's take `t('he', null, {project: 'hi', notes: 'greeting'});`. The function will return `"hivalue:henotes:greeting"`. As you can see, `value:` is prepended to the value, and `notes:` is prepended to the notes. The value for `project` is always the first item of the returned key.

If there is no `notes` value, as in the case `t('he', null, {project: 'campaigns'});`, then it is simply `project + value`, resulting in  `campaignsvalue:he`.

`resolvedStringValue` is simply the value of `<T>` and `t()`. In the case of
`<Plural>` and `pluralize`, `resolvedStringValue` is a concatenation of the
`one` and `other` values.

Duplicate uid's mean translation helpers with the same notes/value appear in the
same project. Engineers can most commonly disambiguate strings that resolve to
the same uid by setting different notes on different translation helper instances,
with the notes used to meaningfully differentiate those instances for translation.
