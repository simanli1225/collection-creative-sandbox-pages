---
kind: pipeline
type: docker
name: session-info
trigger:
  event:
  - push

environment:
  NPM_CONFIG_REGISTRY: https://artifactory.squarespace.net:443/artifactory/api/npm/npm-all/

steps:
- name: npm_install
  pull: always
  image: node:16
  commands:
    - npm ci --include=dev

- name: build
  pull: always
  image: node:16
  commands:
    - npm run build
  depends_on:
    - npm_install

- name: test
  image: node:16
  depends_on:
    - npm_install
  commands:
    - npm run test

- name: npm_publish
  image: plugins/npm
  settings:
    token:
      from_secret: npm_server_publish_token
    registry:
      from_secret: npm_registry_url
  depends_on:
    - build
    - test
  when:
    branch:
      - master