"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var react_1 = tslib_1.__importDefault(require("react"));
var prop_types_1 = tslib_1.__importDefault(require("prop-types"));
var pickBy_1 = tslib_1.__importDefault(require("lodash/pickBy"));
var componentUtils_1 = require("./componentUtils");
var renderComponent_1 = require("./renderComponent");
var T = function (_a) {
    var children = _a.children, formatter = _a.formatter, locale = _a.locale, notes = _a.notes, project = _a.project, htmlAttributesTransform = _a.htmlAttributesTransform, rest = tslib_1.__rest(_a, ["children", "formatter", "locale", "notes", "project", "htmlAttributesTransform"]);
    var compProps = {};
    var nonComponentProps = {};
    var value = children;
    if (!value) {
        return null;
    }
    if (typeof value !== 'string') {
        return (0, renderComponent_1.renderComponent)(null, value);
    }
    Object.keys(rest).forEach(function (propKey) {
        var valueInRest = rest[propKey];
        if (!react_1.default.isValidElement(valueInRest)) {
            nonComponentProps[propKey] = valueInRest;
        }
        else {
            compProps[propKey] = valueInRest;
        }
    });
    var opts = (0, componentUtils_1.propsToOpts)(project, notes);
    var formattedValue = formatter(value, nonComponentProps, opts);
    var parsedStringToArray = (0, componentUtils_1.parseString)(value);
    var htmlAttributeProps = (0, pickBy_1.default)(nonComponentProps, function (_value, key) {
        return !parsedStringToArray.includes("{".concat(key, "}"));
    });
    var stringSubstitutions = (0, componentUtils_1.shallowDifference)(nonComponentProps, htmlAttributeProps);
    var subsObj = {
        strings: Object.keys(stringSubstitutions),
    };
    if (Object.keys(compProps).length > 0) {
        var _b = (0, componentUtils_1.performComponentSubs)(formattedValue, compProps), resolvedChildren = _b.children, replaced = _b.replaced;
        subsObj.components = replaced;
        htmlAttributeProps = htmlAttributesTransform(formattedValue, subsObj, htmlAttributeProps);
        return (0, renderComponent_1.renderComponentWithChildren)(resolvedChildren, htmlAttributeProps);
    }
    htmlAttributeProps = htmlAttributesTransform(formattedValue, subsObj, htmlAttributeProps);
    return (0, renderComponent_1.renderComponent)(htmlAttributeProps, formattedValue);
};
T.propTypes = {
    children: prop_types_1.default.oneOfType([prop_types_1.default.string, prop_types_1.default.array, prop_types_1.default.element]),
    formatter: prop_types_1.default.func.isRequired,
    notes: prop_types_1.default.string,
    project: prop_types_1.default.string.isRequired,
};
exports.default = T;
