"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createWriter = void 0;
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const mkdirp_1 = __importDefault(require("mkdirp"));
function writeSync(outputPath, contents) {
    mkdirp_1.default.sync(path_1.default.dirname(outputPath));
    fs_1.default.writeFileSync(outputPath, contents);
}
function createWriter() {
    let firstRun = true;
    return (newContent, outputPath, cb) => {
        fs_1.default.readFile(outputPath, 'utf8', (readError, data) => {
            if (readError && !firstRun) {
                return cb(readError);
            }
            data = firstRun ? '{}' : data || '{}';
            let oldContent;
            try {
                oldContent = JSON.parse(data);
            }
            catch (parseError) {
                oldContent = {};
            }
            const output = JSON.stringify(Object.assign(Object.assign({}, oldContent), newContent));
            try {
                writeSync(outputPath, output);
                firstRun = false;
                cb();
            }
            catch (writeError) {
                return cb(writeError);
            }
        });
    };
}
exports.createWriter = createWriter;
//# sourceMappingURL=fileWriter.js.map