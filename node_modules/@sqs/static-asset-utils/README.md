# Static Asset Utils

**TABLE OF CONTENTS**

- [generateStaticAssetManifest](#generate-static-asset-manifest)
- [generateStaticAssetPaths](#generate-static-asset-paths)
- [StaticAssetManifestPlugin](#static-asset-manifest-plugin)

## Install
```
npm install @sqs/static-asset-utils
```

## Usage
```js
import { generateStaticAssetManifest, generateStaticAssetPaths, StaticAssetManifestPlugin } from '@sqs/static-asset-utils';
```

<a name="generate-static-asset-manifest"></a>
## generateStaticAssetManifest

Generates the manifest used by the [static asset CLI](https://github.com/sqsp/static-asset-cli) to upload assets to GCS.

The manifest is a mapping of an asset's name to its **localPath** and **remotePath**.

```json
 {
    "images/a.png": {
        "localPath": "dist/images/a.png",
        "remotePath": "/my-app/images/a.png"
    }
 }
```

The CLI tool takes the file at the `localPath` and streams it to GCS at the `remotePath`

  - `localPath` is the local filesystem path relative to the project root.
  - `remotePath` is the path, relative to the static asset host name, at which the asset will be stored

  ***NOTE:*** The local path is determined in relation to the `projectRoot`, whereas the remote path is determined in relation to the `assetsRoot`.

### Arguments

The function takes a configuration object with the following properties:

- `files` [_required_]: A list of glob patterns to match the assets. Example: ['./dist/**/*']. Read more about the glob matcher [Node-glob](https://github.com/isaacs/node-glob).

- `manifestOutputFile` [_required_]: Path to the manifest json file. Example: './dist/static-asset-manifest.json'

- `projectName` [_recommended_]: Prefix the remote assets path ("SAS_HOST_NAME/PROJECT_NAME/images/a.png")
Defaults to the name of the project root directory.

- `projectRoot` [_optional_]: Default: the cwd of the node process running this script. Points to the directory that `localPath` is relative to.
Configure projectRoot if you don't run `generateStaticAssetManifest` from the same directory from which you run the static asset cli that uploads the assets.

- `assetsRoot` [_optional_]: Default: `projectRoot`. Points to the directory that `remotePath` is relative to.

- `globBase` [_optional_]: Default: the absolute segment of the file glob. Passed to [glob-stream as its globbing base](https://www.npmjs.com/package/glob-stream#optionsbase).
Affects the manifest json key formation (see `manifestKeyTransformFn`)

- `manifestKeyTranformFn` [_optional_]: Customize assets keys in the manifest. By default, the key is the file's relative path based on the absolute segment of the file glob. 
Takes a file's relative path and returns its corresponging manifest key. [Read more about how the relative path is derived from the file glob](https://github.com/gulpjs/glob-parent)




### Example usage
```js
// Based on this project structure:
// 
// my-app/
//       dist/
//           images/
//                 a.png
//           main-123abc-min.js 
//       scripts/
//             generateManifest.js

// And:
// scripts/generateManifest.js

```
#### Default
```js
const generateStaticAssetManifest = require('@sqs/static-asset-utils').generateStaticAssetManifest;

const files = ['./dist/**/*'];
const manifestOutputFile = './dist/static-asset-manifest.json';
const projectName: 'MY_APP';

generateStaticAssetManifest({files, manifestOutputFile, projectName });

```
 Run:
 ```sh
 $ cd my-app
 $ node ./scripts/generateManifest.js
```
To generate:

```json
// my-app/dist/static-asset-manifest.json
 {
    "images/a.png": {
        "localPath": "dist/images/a.png",
        "remotePath": "/MY_APP/dist/images/a.png"
    },
    "main-123abc-min.js": {
        "localPath": "dist/main-123abc-min.js",
        "remotePath": "/MY_APP/dist/main-123abc-min.js"      
    }
 }
```

#### Customize the manifest key

Add a `manifestKeyTransformFn` to the config:

```js
function manifestKeyTransformFn(filename) {
  const filenamePattern = /(-\w+-min)\./;
  const hashMatches = filenamePattern.exec(filename);

  if (hashMatches) {
    return filename.replace(hashMatches[1], '');
  }

  return filename;
}

generateStaticAssetManifest({files, manifestOutputFile, projectName, manifestKeyTransformFn });

```

To generate:
```json
 {
    "main.js": {
        "localPath": "dist/main-123abc-min.js",
        "remotePath": "/MY_APP/dist/main-123abc-min.js"      
    }
 }
```

#### Customize `remotePath`

Add a `assetsRoot` to the config:

```js
const assetsRoot = 'dist';

generateStaticAssetManifest({files, manifestOutputFile, projectName, manifestKeyTransformFn });

```

To generate:
```json
 {
    "main.js": {
        "localPath": "dist/main-123abc-min.js",
        "remotePath": "/MY_APP/main-123abc-min.js"      
    }
 }
```

<a name="generate-static-asset-paths"></a>
## generateStaticAssetPaths

Same as `generateStaticAssetManifest`, except that instead of writing the manifest to the file system, it returns it as an object in a Promise.

<a name="static-asset-manifest-plugin"></a>
## StaticAssetManifestPlugin

A plugin that generates the manifest used by the [static asset CLI](https://github.com/sqsp/static-asset-cli) to upload assets to GCS.

 
### Options

_`Object`_

#### `debug`

_`Boolean`_

Default: false

#### `outputFilePrefix`

_`String`_

Default: 'manifest'

Customize the manifest filename. By default, it is output as `manifest.[locale].json`

#### `locale`

_`String`_

**Required** in locale-specific builds.

#### `projectName`

_`String`_

**Required** 

The app's namespace in the Static Asset Origin.

If you are using SAS in local dev with Webpack Dev Server, `projectName` should correspond to `devServer.publicPath`.
If you want to serve assets at the root (from the view of the HTML page), you *can* set to '/', with the caveat:
**DO NOT** set `projectName` to '/' in production, or you will pollute the static asset origin with assets without a namespace.

#### `customAssets`

_`Object`_

Configure the Plugin to add manifest entries for files that are not processed by Webpack. 

  * `nonWebpackContent` - A list of glob patterns to match the assets. Example: ['./static/**/*']. Read more about the glob matcher [Node-glob](https://github.com/isaacs/node-glob).

  * `projectRoot` [_optional_]: Defaults to the webpack context. Points to the directory that `localPath` is relative to.

  * `assetsRoot` [_optional_]: Default: `projectRoot`. Points to the directory that `remotePath` is relative to.


### Usage
```js
const StaticAssetManifestPlugin = require('@sqs/static-asset-utils').StaticAssetManifestPlugin;

module.exports = {
  plugins: [
    new StaticAssetManifestPlugin({
      locale: 'en-US',
      projectName: 'my-app'
    })
  ]
}
```