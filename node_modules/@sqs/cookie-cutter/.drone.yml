---
kind: pipeline
type: docker
name: sqs-cookie-cutter
trigger:
  event: [push, tag]

steps:
  - name: install
    image: squarespace/node-base:v18
    commands:
      - npm ci --legacy-peer-deps --ignore-scripts

  - name: test
    image: squarespace/node-base:v18
    commands:
      - npm run test
    depends_on:
      - install

  - name: pre-release
    image: plugins/npm
    environment:
      NPM_CONFIG_REGISTRY:
        from_secret: npm_registry_url
    settings:
      tag: ${DRONE_BRANCH//\//-}
      token:
        from_secret: npm_server_publish_token
      registry:
        from_secret: npm_registry_url
    when:
      branch:
        - pre-release/*
    depends_on:
      - test

  - name: npm_publish
    image: plugins/npm
    environment:
      NPM_CONFIG_REGISTRY:
        from_secret: npm_registry_url
    settings:
      token:
        from_secret: npm_server_publish_token
      registry:
        from_secret: npm_registry_url
    when:
      event: [tag]
    depends_on:
      - test
