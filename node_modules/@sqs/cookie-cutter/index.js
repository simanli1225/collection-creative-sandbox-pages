var SPLIT_COOKIE_KEY_VALUE = /^([^=]+)=([^;]*)$/;
var exports = module.exports = function (doc, shouldEscapeCookie) {
    if (!doc) doc = {};
    if (typeof doc === 'string') doc = { cookie: doc };
    if (doc.cookie === undefined) doc.cookie = '';
    if (shouldEscapeCookie !== false) shouldEscapeCookie = true;

    var identity = function (str) { return str; }
    var _escape = shouldEscapeCookie ? escape : identity;
    var _unescape = shouldEscapeCookie ? unescape : identity;
    
    var self = {};
    self.get = function (key) {
        var splat = doc.cookie.split(/;\s*/);
        for (var i = 0; i < splat.length; i++) {
            var splitCookie = (splat[i]||'').match(SPLIT_COOKIE_KEY_VALUE) || [];
            var k = _unescape(splitCookie[1] || '');
            if (k === key) return _unescape(splitCookie[2] || '');
        }
        return undefined;
    };
    
    self.set = function (key, value, opts) {
        if (!opts) opts = {};
        var s = _escape(key) + '=' + _escape(value);
        if (opts.expires) s += '; expires=' + opts.expires;
        if (opts.path) s += '; path=' + _escape(opts.path);
        if (opts.domain) s += '; domain=' + _escape(opts.domain);
        if (opts.secure) s += '; secure';
        doc.cookie = s;
        return s;
    };
    return self;
};

if (typeof document !== 'undefined') {
    var cookie = exports(document);
    exports.get = cookie.get;
    exports.set = cookie.set;
}
