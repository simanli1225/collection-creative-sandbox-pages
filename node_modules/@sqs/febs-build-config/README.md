## @sqs/febs-build-config

Frontend build system build default Webpack configurations and helpers.

**TABLE OF CONTENTS**

- [API](#api)

    - [`getWebpackConfig`](#getWebpackConfig)
    - [`rewriteFileTemplate`](#rewriteFileTemplate)

- [Webpack Config Enhancements](#webpack-config-enhancements)

    - [`compose`](#compose)
    - [`withI18n`](#withI18n)
    - [`withLess`](#withLess)
    - [`withTypeScript`](#withTypeScript)
    - [`withStats`](#withStats)
    - [`withPublic`](#withPublic)
    - [`withManifest`](#withManifest)

- [I18n helpers](#i18n-helpers)

    - [`loadLanguagePacks`](#loadLanguagePack)

- [Constants](#constants)

---------

<a name="api"></a>
## API

<a name="getWebpackConfig"></a>
### `getWebpackConfig`

_`Function`_ `(envOptions?: Object, febsConfig?: Object) => Webpack config Object`

Provides the default FEBS Webpack config.

#### Arguments

- `envOptions` [_optional_]: Used to pass in locale information. For example; `{ locale: 'fr-FR' }`.
- `febsConfig` [_optional_]: A valid [FEBS configuration Object](../febs-cli/README.md).

#### Example usage

```js
//webpack.config.js
const { getWebpackConfig } = require('@sqs/febs-build-config');

module.exports = getWebpackConfig;
```

#### Example usage as a base config

Here is an example of importing the base Webpack config from FEBS and extending/overriding it in your application:

```js
// webpack.config.js
const { getWebpackConfig } = require('@sqs/febs-build-config');
const merge = require('webpack-merge');

module.exports = (env, argv) => {
  const baseConfig = getWebpackConfig(env, argv);

  return merge(baseConfig, {
    /* Webpack config overrides here */
  });
};
```

Locale information and the current FEBS config object will be passed in to `webpack.config.js` above via the `env` and `argv` arguments respectively.

When using this webpack config outside of `@sqs/febs-cli`, you will need to define the `paths` property on the `argv` argument. For more information on `paths`, please refer to the [@sqs/febs-cli documentation](../febs-cli/README.md)

<a name="rewriteFileTemplate"></a>
### `rewriteFileTemplate`

_`Function`_ `(template: String, replacements: Object) => String`

Replaces values in the template String wrapped with `[]` with the matching substitution in the replacements Object.

#### Example usage

```js
const { rewriteFileTemplate } = require('@sqs/febs-build-config');

const template = 'index.[locale].js';
const substitutions = {
  locale: 'en-US',
};

rewriteFileTemplate(template, substitutions); // === 'index.en-US.js'
```

<a name="webpack-config-enhancements"></a>
## Webpack config enhancements

We provide a number of helpers you can use to constuct your webpack config from the bare-bones base config and a number of enhancers that add functionality. Here is an example that builds up our default config from the base and mixins:


```js
const { getOptions } = require('@sqs/febs-utils');
const { compose, baseWebpackConfig, withI18n, withImages, withLess, withPublic, withTypescript, withStats } = require('@sqs/febs-build-confg');

module.exports = (env, argv) => {
  // Load the configuration from defaults, febs.config, environment variables, and command line options.
  argv = getOptions(argv);

  const baseConfig = baseWebpackConfig(env, argv);
  
  const enhancers = [
    withPublic(argv),
    withLess({}, argv),
    withTypeScript({
      pluginOptions: {
        tslint: true,
      },
    }),
    withI18n(
      {
        filenameTemplate: '[name]-[contenthash]-min.[locale].js',
        locale: env.locale,
      },
      argv
    ),
    withImages(),
    withStats({ locale: env.locale }, argv),
  ];

  const enhance = compose(...enhancers);
  return enhance(config);
};
```

<a name="compose"></a>
### `compose`

_`Function`_ `(...enhancers) => (webpackConfig: Object) => Object`

While not an enhancement itself, this utility composes multiple Webpack config enhancements into a single enhancement that can be applied to a Webpack config Object. The returned Object at the end of the chain is the enhanced Webpack config.

#### Arguments

- `enhancers`: Any number of Webpack config enhancers (listed below).
- `webpackConfig`: A Webpack config object.

#### Example usage

```js
// webpack.config.js
const { compose, withI18n, withTypeScript } = require('@sqs/febs-build-config');

const webpackConfig = {
  entry: {
    main: './src/index',
  },
};

const enhance = compose(
  withI18n({
    /* options */
  }),
  withTypeScript({
    /* options */
  })
);

const enhancedWebpackConfig = enhance(webpackConfig);

module.exports = enhancedWebpackConfig;
```

<a name="withLess"></a>
### `withLess`

_`Function`_ `(options: Object) => Object`

A Webpack config enhancement that enables LESS -> CSS transformations for your Webpack config.
Takes an optional `options` Object as an argument and returns an `enhancer` function that takes a Webpack config Object and returns an enhanced Webpack config Object.

#### Options

##### `inline`

_`Boolean`_

Setting this to `true` inlines CSS in the bundled JS. Setting this to `false` generates an external stylesheet.

Defaults to `false`.

##### `postcssOptions`

_`Object`_

Additional options to pass to the [`postcss-loader`](https://webpack.js.org/loaders/postcss-loader/#options).

By default, `postcss-loader` will use [`autoprefixer`](https://github.com/postcss/autoprefixer) and will resolve to your projects `.browserslistrc` config for browser support.
Specifying this option might be useful if you want to add additional plugins to the `postcss-loader`, such as [`postcss-flexbugs-fixes`](https://github.com/luisrudge/postcss-flexbugs-fixes), for example.

##### `resolver`

_`(moduleName: string) => string`_

Custom resolver function that takes a module id as an input and returns the resolved path to that module. This is used to resolve loaders and plugins.

Defaults to `require.resolve`.

##### `optimize`

_`Boolean | Object`_

Controls various optimizations for the `withLess` enhancer.

The optimizations are:
- `minifyCssClassNames` - `Boolean`: CSS class names are hashed for production builds.
Instead of "Component-LocalName-12345", class names will be only a hash (e.g. "a1b2c3_-").
Note that production code **must not** rely on selectors like `"[class*=Component...]"` or `"[class^=Component...]"` to enable this optimization.

Accepted values:
- An object with keys set to an optimization defined above.
The object is merged with an object that has all optimizations enabled.
- `true` turns all optimizations on.
- `false` turns all optimizations off.

Defaults to `false`.

#### Example usage

```js
// webpack.config.js
const { withLess } = require('@sqs/febs-build-config');

const webpackConfig = {
  entry: {
    main: './src/index',
  },
};

const enhance = withLess({
  /* options here */
}),

module.exports = enhance(webpackConfig);
```

<a name="withI18n"></a>
### `withI18n`

_`Function`_ `(options: Object) => Object`

A Webpack config enhancement that enables i18n configurations in your Webpack config. Takes an `options` Object as an argument and returns an `enhancer` function that takes a Webpack config Object and returns an ehanced Webpack config Object.

#### Options

##### `appPaths`

_`Object`_

An object containing the paths to directories in your application. Uses the following shape: `{ frontendBuildCache: String; src: String; translations: String }`.

For more information on these paths, please refer to the [@sqs/febs-cli documentation](../febs-cli/README.md)

##### `locale`

_`String`_

The locale you are building for.

##### `filenameTemplate`

_`String`_

The filename template to use for Webpack's file and chunk output.

#### Example usage

```js
// webpack.config.js
const { withI18n, FILENAME_TEMPLATE_DEV } = require('@sqs/febs-build-config');

const webpackConfig = {
  entry: {
    main: './src/index',
  },
};

const enhance = withI18n({
  appPaths: {
    frontendBuildCache: './node_modules/.cache',
    src: './src',
    translations: './translations',
  },
  filenameTemplate: FILENAME_TEMPLATE_DEV,
  locale: 'es-419',
}),

module.exports = enhance(webpackConfig);
```

<a name="withTypeScript"></a>
### `withTypeScript`

_`Function`_ `(options: Object) => Object`

A Webpack config enhancement that enables TypeScript configurations in your Webpack config. Takes an optional `options` Object as an argument and returns an `enhancer` function that takes a Webpack config Object and returns an ehanced Webpack config Object.

#### Options

An object of options to pass through to the [fork-ts-checker-webpack-plugin](https://www.npmjs.com/package/fork-ts-checker-webpack-plugin).
All available options are listed [in the plugin documentation](https://www.npmjs.com/package/fork-ts-checker-webpack-plugin#options)

#### Example usage

```js
// webpack.config.js
const { withTypeScript } = require('@sqs/febs-build-config');

const webpackConfig = {
  entry: {
    main: './src/index',
  },
};

const enhance = withTypeScript({
  /* options here */
}),

module.exports = enhance(webpackConfig);
```

<a name="withStats"></a>
### `withStats`

_`Function`_ `(options: Object) => Object`

A Webpack config enhancement that enables the collection of file size and webpack speed metrics. Takes an `options` Object as an argument and returns an `enhancer` function that takes a Webpack config Object and returns an ehanced Webpack config Object.
The enhancement will configure:
  - BundleAnalyzerPlugin to write input bundle metrics to <dist>/webpack-input-stats.json', only for the default en-US locale build.
  - SpeedMeasurePlugin to wrtie plugin and loader speed metrics to <dist>/'webpack-speed-stats.json', only for the default en-US locale build.

#### Options

##### `appPaths`

_`Object`_

An object containing the paths to directories in your application. The `dist` directory is the required one here. Uses the following shape: `{ dist: String }`.

For more information on these paths, please refer to the [@sqs/febs-cli documentation](../febs-cli/README.md)

##### `locale`

_`String`_

The locale you are building for.

#### Example usage

```js
// webpack.config.js
const { withStats } = require('@sqs/febs-build-config');

const webpackConfig = {
  entry: {
    main: './src/index',
  },
};

const enhance = withStats({
  appPaths: { dist: 'dist'},
  locale: 'en-US'
}),

module.exports = enhance(webpackConfig);
```

<a name="withPublic"></a>
### `withPublic`
_`Function`_ `(options: Object) => Object`

A Webpack config enhancement that helps create an entrypoint template. It uses the HtmlWebpackPlugin to add js and css bundles to index.html. It also handles favicon processing. 

#### Options

_`Object`_

##### paths
_`Object`_

An object containing the paths to directories in your application. The `public` directory is the required one here. Uses the following shape: `{ public: String }`.

For more information on these paths, please refer to the [@sqs/febs-cli documentation](../febs-cli/README.md)

#### Example usage

- Add the enhancement to your webpack config
```js
// webpack.config.js
const { withPublic } = require('@sqs/febs-build-config');

const webpackConfig = {
  entry: {
    main: './src/index',
  },
};

const enhance = withPublic({
    paths: {
      public: '/absolute/path/to/public'
    }
});

module.exports = enhance(webpackConfig);
```

- Require the favicon, so that it gets hashed and output to your `dist` directory. 

```html
<!-- public/index.html -->
<!doctype html>
<html>
  <head>
    <link rel="shortcut icon" href="${require('./favicon.ico')}">
  <head>
  <body>
    <div id="root">
    </div>
  </body>
<html>
```

<a name="withManifest"></a>
### `withManifest`
_`Function`_ `(options: Object) => Object`

A Webpack config enhancement that adds a Static Asset Manifest Plugin to the `plugins` list.
The plugin generates the manifest used by the [static asset CLI](https://github.com/sqsp/static-asset-cli) to upload assets to GCS.

#### Options

Options are passed through to the Plugin. See the [StaticAssetManifestPlugin documentation](../static-asset-utils/README.md#static-asset-manifest-plugin).

#### Example usage

```js
// webpack.config.js
const { withManifest } = require('@sqs/febs-build-config');

const webpackConfig = {
  entry: {
    main: './src/index',
  },
};

const enhance = withManifest({
    locale: 'es-419',
    projectName: 'febs-example-webapp',
});

module.exports = enhance(webpackConfig);
```

#### Verifying this Locally

`withManifest` will output the manifest file to your `output` directory.

By default, this should be `dist/manifest.<locale>.json`.

<a name="i18n-helpers"></a>
## I18n helpers

<a name="loadLanguagePack"></a>
### `loadLanguagePack`

_`Function`_ `(locale: Object, langPath: String) => Object`

Parses YAML files for the specified locale and returns an Object of translated strings keyed by their unique hash.

#### Arguments

- `locale`: Takes an object of the following shape: `{ label?: String; locale: String; language: String }`.
- `langPath`: Path to the directory containing your YAML translation files.

<a name="constants"></a>
## Constants

### `FILENAME_TEMPLATE_DEV`

_`String`_ `'[name].[locale].js'`

Webpack filename template used in development.

### `FILENAME_TEMPLATE_PROD`

_`String`_ `'[name]-[contenthash]-min.[locale].js'`

Webpack filename template used in production.

### `BRANCH_ENV_KEY`

_`String`_ `'BRANCH_NAME'`

Drone environment variable for the current branch name.

### `BUILD_ENV_KEY`

_`String`_ `'BUILD_NUMBER'`

Drone environment variable for the current build number.
