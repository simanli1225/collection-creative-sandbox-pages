{"version":3,"file":"pack.js","sourceRoot":"","sources":["../../src/resource/pack.ts"],"names":[],"mappings":"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","sourcesContent":["import { LanguageTag } from '@phensley/language-tag';\nimport { LanguageResolver } from '@phensley/locale';\nimport { Bundle, ExceptionIndex, StringBundle } from './bundle';\nimport { numarray } from '../utils/string';\n\nconst enum Chars {\n  // Fields in a resource pack are separated by an UNDERSCORE character\n  DELIM = '_',\n}\nconst U = undefined;\n\n/**\n * Layer in the pack that supports all regions for a single language + script.\n *\n * @public\n */\nexport class PackScript {\n  private _strings: string[];\n  private _exceptions: string[];\n  private _regions: { [x: string]: string };\n  private _cache: { [x: string]: ExceptionIndex } = {};\n  private _defaultRegion: string;\n\n  constructor(\n    strings: string,\n    exceptions: string,\n    regions: { [x: string]: string },\n    defaultRegion: string,\n    private _spellout: any,\n  ) {\n    this._strings = strings.split(Chars.DELIM);\n    this._exceptions = exceptions.split(Chars.DELIM);\n    this._regions = regions;\n    this._defaultRegion = defaultRegion;\n  }\n\n  get(tag: LanguageTag): Bundle {\n    let region = tag.region();\n    let index = this._cache[region] || this.decode(region);\n    if (index === U) {\n      region = this._defaultRegion;\n      tag = new LanguageTag(tag.language(), tag.script(), region, tag.variant(), tag.extensions(), tag.privateUse());\n      index = this._cache[region] || this.decode(region);\n    }\n    return new StringBundle(tag.compact(), tag, this._strings, this._exceptions, index, this._spellout);\n  }\n\n  private decode(region: string): ExceptionIndex | undefined {\n    const raw = this._regions[region];\n    if (raw === U) {\n      return U;\n    }\n\n    const decoded = numarray(raw, 36);\n    const index: ExceptionIndex = {};\n    for (let i = 0; i < decoded.length; i += 2) {\n      const k = decoded[i];\n      const v = decoded[i + 1];\n      index[k] = v;\n    }\n    this._cache[region] = index;\n    return index;\n  }\n}\n\n/**\n * Runtime resource pack manager.\n *\n * @public\n */\nexport class Pack {\n  readonly version: string;\n  readonly cldrVersion: string;\n  readonly checksum: string;\n  readonly language: string;\n  readonly defaultTag: LanguageTag;\n  readonly scripts: { [x: string]: PackScript } = {};\n  readonly spellout: any;\n\n  constructor(data: string | any) {\n    const raw: any = typeof data === 'string' ? JSON.parse(data) : data;\n    const { version, cldr, checksum, language, spellout } = raw;\n    if (version === U) {\n      throw new Error('Severe error: data does not look like a valid resource pack.');\n    }\n\n    this.version = version;\n    this.cldrVersion = cldr;\n    this.checksum = checksum;\n    this.language = language;\n    this.spellout = spellout;\n    this.defaultTag = LanguageResolver.resolve(raw.defaultTag);\n\n    Object.keys(raw.scripts).forEach((k) => {\n      const obj = raw.scripts[k];\n      this.scripts[k] = new PackScript(obj.strings, obj.exceptions, obj.regions, obj.defaultRegion, this.spellout);\n    });\n  }\n\n  get(tag: LanguageTag): Bundle {\n    // We need the script and region to find the correct string layer. Caller should\n    // ideally supply a resolved language tag to avoid the overhead of this call.\n    if (!tag.hasLanguage() || !tag.hasScript() || !tag.hasRegion()) {\n      tag = LanguageResolver.resolve(tag);\n    }\n\n    // Strings for a language are organized by script.\n    let script = this.scripts[tag.script()];\n    if (script === U) {\n      // Swap in the default script\n      tag = new LanguageTag(\n        this.defaultTag.language(),\n        this.defaultTag.script(),\n        this.defaultTag.region(),\n        this.defaultTag.variant(),\n        tag.extensions(),\n        tag.privateUse(),\n      );\n      script = this.scripts[tag.script()];\n    }\n    return script.get(tag);\n  }\n}\n"]}